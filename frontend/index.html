<!-- frontend/index.html -->
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>ChromaSky - 火烧云指数地图</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
    
    <!-- 1. 引入 MapLibre GL JS 的 CSS (通过 CDN) -->
    <link href="https://unpkg.com/maplibre-gl@4.3.2/dist/maplibre-gl.css" rel="stylesheet" />
    
    <!-- 2. 引入 MapLibre GL JS 的 JavaScript (通过 CDN) -->
    <script src="https://unpkg.com/maplibre-gl@4.3.2/dist/maplibre-gl.js"></script>
    
    <style>
        body { margin: 0; padding: 0; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }
        .map-overlay {
            font-family: Arial, sans-serif;
            background: rgba(255, 255, 255, 0.8);
            position: absolute;
            bottom: 20px;
            right: 20px;
            padding: 10px;
            border-radius: 3px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }
        .legend-key {
            display: inline-block;
            border-radius: 20%;
            width: 10px;
            height: 10px;
            margin-right: 5px;
        }
    </style>
</head>
<body>

<div id="map"></div>
<div id="info" class="map-overlay">
    <h4>火烧云指数</h4>
    <div><span class="legend-key" style="background-color: #d0021b;"></span>8 - 10 (绝佳)</div>
    <div><span class="legend-key" style="background-color: #f5a623;"></span>6 - 8 (良好)</div>
    <div><span class="legend-key" style="background-color: #50e3c2;"></span>4 - 6 (一般)</div>
    <div><span class="legend-key" style="background-color: #4a90e2;"></span>2 - 4 (较差)</div>
</div>

<script>
    // 3. 初始化地图
    const map = new maplibregl.Map({
        container: 'map',
        style: `https://api.maptiler.com/maps/toner-v2/style.json?key=COzW8kKwrFCzdf13x98K`,
        center: [115, 35], // 将中心点设在中国区域
        zoom: 3.5
    });

    // 定义颜色梯度，用于将分数映射到颜色
    const CHROMA_COLORS = [
        2, '#4a90e2',  // 分数 >= 2, 蓝色
        4, '#50e3c2',  // 分数 >= 4, 青色
        6, '#f5a623',  // 分数 >= 6, 黄色
        8, '#d0021b'   // 分数 >= 8, 红色
    ];

    map.on('load', () => {
        // 4. 添加 GeoJSON 数据源
        map.addSource('chromasky-data', {
            type: 'geojson',
            // 从我们后端提供的静态路径加载数据
            data: '/api/v1/chromasky/map_data?event=tomorrow_sunrise&density=high'
        });

        // 5. 添加热力图图层
        map.addLayer({
            id: 'chromasky-heatmap',
            type: 'heatmap',
            source: 'chromasky-data',
            maxzoom: 6, // 在缩放级别低于6时显示热力图
            paint: {
                'heatmap-weight': [
                    'interpolate', ['linear'], ['get', 'score'],
                    0, 0,
                    10, 1
                ],
                'heatmap-intensity': 1.5,
                'heatmap-color': [
                    'interpolate', ['linear'], ['heatmap-density'],
                    0, 'rgba(0, 0, 255, 0)',
                    0.2, 'royalblue',
                    0.4, 'cyan',
                    0.6, 'lime',
                    0.8, 'yellow',
                    1, 'red'
                ],
                'heatmap-radius': 25,
                'heatmap-opacity': 0.8
            }
        });

        // 6. 添加圆点图层 (在高缩放级别下显示)
        map.addLayer({
            id: 'chromasky-points',
            type: 'circle',
            source: 'chromasky-data',
            minzoom: 5, // 在缩放级别高于5时显示圆点
            paint: {
                'circle-radius': 4,
                'circle-color': [
                    'step',
                    ['get', 'score'],
                    '#cccccc', // 默认颜色 (分数 < 2)
                    ...CHROMA_COLORS
                ],
                'circle-stroke-color': 'white',
                'circle-stroke-width': 0.5,
                'circle-opacity': 0.8
            }
        });
    });
</script>

</body>
</html>